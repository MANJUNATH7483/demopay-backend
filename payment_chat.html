<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Chat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { background-color: #efe7dd; background-image: linear-gradient(rgba(255,255,255,0.5), rgba(255,255,255,0.5)); display: flex; flex-direction: column; height: 100vh; margin: 0; overflow: hidden; font-family: sans-serif; }
    
    .chat-header { background: #5f259f; color: white; padding: 10px 15px; display: flex; align-items: center; gap: 15px; position: relative; z-index: 50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .user-avatar { width: 35px; height: 35px; background: white; color: #5f259f; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    
    .chat-container { flex: 1; overflow-y: auto; padding: 20px 15px 90px; display: flex; flex-direction: column; gap: 15px; }
    .bubble { max-width: 75%; padding: 10px 15px; border-radius: 15px; font-size: 14px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
    .bubble.sent { align-self: flex-end; background: #e2ffc9; border-top-right-radius: 0; }
    .bubble.paid { align-self: flex-end; background: white; border: 1px solid #ddd; border-top-right-radius: 0; }
    .amt-large { font-size: 24px; font-weight: bold; color: #333; margin: 5px 0; }

    .chat-footer { position: absolute; bottom: 0; width: 100%; background: white; padding: 10px 15px; display: flex; align-items: center; gap: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 60; box-sizing: border-box; }
    .msg-input { flex: 1; padding: 12px 20px; border-radius: 25px; border: 1px solid #ddd; outline: none; background: #f9f9f9; font-size: 14px; }
    .action-btn { border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold; font-size: 14px; cursor: pointer; color: white; display: flex; align-items: center; gap: 5px; }
    .btn-send { background: #0084ff; padding: 12px; border-radius: 50%; }
    .btn-pay { background: #5f259f; padding: 10px 25px; border-radius: 25px; }

    .overlay-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; z-index: 1000; }
    #bankSheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; z-index: 1500; padding: 20px; transition: 0.3s; box-sizing: border-box; }
    .sheet-visible { bottom: 0 !important; }
    .bank-option { display: flex; align-items: center; gap: 15px; padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }

    #pinOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #101010; color: white; display: none; flex-direction: column; z-index: 2000; }
    .pin-header { background: #202020; padding: 15px; display: flex; justify-content: space-between; }
    .pin-body { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .pin-dots { display: flex; gap: 20px; margin-top: 30px; }
    .p-dot { width: 10px; height: 10px; border: 1px solid white; border-radius: 50%; }
    .p-filled { background: white; }
    .pin-keypad { background: #151515; padding: 20px; }
    .pk-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .pk-key { width: 30%; height: 60px; font-size: 28px; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .pk-key:active { background: #333; }
  </style>
</head>
<body>
  <div class="chat-header">
    <i class="fa-solid fa-arrow-left" onclick="history.back()" style="cursor:pointer;"></i>
    <div class="user-avatar" id="uAvatar">U</div>
    <div style="flex: 1;"><h4 style="margin: 0;" id="uName">User</h4><span style="font-size: 11px;" id="uMobile">+91 ...</span></div>
  </div>
  <div class="chat-container" id="chatList"><div style="text-align: center; font-size: 11px; color: #888;">TODAY</div></div>
  <div class="chat-footer">
    <input type="text" class="msg-input" id="inputBox" placeholder="Message or Amount..." oninput="checkInput()">
    <button class="action-btn btn-send" id="actionButton" onclick="handleAction()"><i class="fa-solid fa-paper-plane"></i></button>
  </div>
  
  <div class="overlay-bg" id="bgOverlay" onclick="closeBankSheet()"></div>
  <div id="bankSheet">
      <h3 style="margin:0 0 20px 0;">Total Payable: <span id="payAmount">â‚¹0</span></h3>
      <div style="font-size:12px; color:#666; margin-bottom:10px;">DEBIT FROM</div>
      
      <div class="bank-option" onclick="openPinScreen('SBI')"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cc/SBI-logo.svg/1200px-SBI-logo.svg.png" style="width:30px;">
          <div style="flex:1;"><div style="font-weight:bold;">State Bank of India</div><div style="font-size:12px;">Account ending in 8829</div></div>
          <i class="fa-solid fa-circle-check" style="color:#5f259f; font-size:20px;"></i>
      </div>

      <div class="bank-option" onclick="openPinScreen('HDFC')"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/HDFC_Bank_Logo.svg/2560px-HDFC_Bank_Logo.svg.png" style="width:30px;">
          <div style="flex:1;"><div style="font-weight:bold;">HDFC Bank</div><div style="font-size:12px;">Account ending in 1234</div></div>
          <i class="fa-regular fa-circle" style="color:#ccc; font-size:20px;"></i>
      </div>
  </div>

  <div id="pinOverlay">
      <div class="pin-header"><span>ENTER UPI PIN</span><span id="pinAmt" style="font-weight:bold;">â‚¹0.00</span></div>
      <div class="pin-body"><div style="font-size:14px; opacity:0.7;" id="pinBankName">State Bank of India (8829)</div>
          <div class="pin-dots"><div class="p-dot" id="d1"></div><div class="p-dot" id="d2"></div><div class="p-dot" id="d3"></div><div class="p-dot" id="d4"></div></div>
      </div>
      <div class="pin-keypad">
          <div class="pk-row"><div class="pk-key" onclick="kp(1)">1</div><div class="pk-key" onclick="kp(2)">2</div><div class="pk-key" onclick="kp(3)">3</div></div>
          <div class="pk-row"><div class="pk-key" onclick="kp(4)">4</div><div class="pk-key" onclick="kp(5)">5</div><div class="pk-key" onclick="kp(6)">6</div></div>
          <div class="pk-row"><div class="pk-key" onclick="kp(7)">7</div><div class="pk-key" onclick="kp(8)">8</div><div class="pk-key" onclick="kp(9)">9</div></div>
          <div class="pk-row"><div class="pk-key"></div><div class="pk-key" onclick="kp(0)">0</div><div class="pk-key" onclick="kd()"><i class="fa-solid fa-delete-left"></i></div></div>
          <div style="margin-top:10px; background:#5f259f; text-align:center; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer;" onclick="submitPin()">SUBMIT</div>
      </div>
  </div>

  <script>
    let amountToPay=0, pin="", correctPin="1234", selectedBankName="SBI", isPaymentMode=false;
    const urlParams=new URLSearchParams(window.location.search);
    const name=urlParams.get('name')||'Merchant', mobile=urlParams.get('mobile')||'...', preFilledAmt=urlParams.get('amt');
    
    document.getElementById('uName').innerText=name; 
    document.getElementById('uMobile').innerText="+91 "+mobile; 
    document.getElementById('uAvatar').innerText=name.charAt(0);
    const input=document.getElementById('inputBox'), btn=document.getElementById('actionButton');

    function checkInput(){
      const val=input.value.trim();
      if(val.length>0 && /^[0-9]+(\.\d+)?$/.test(val)){ isPaymentMode=true; btn.className="action-btn btn-pay"; btn.innerHTML=`Pay â‚¹${val}`; }
      else{ isPaymentMode=false; btn.className="action-btn btn-send"; btn.innerHTML=`<i class="fa-solid fa-paper-plane"></i>`; }
    }

    function handleAction(){
      const val=input.value.trim(); if(!val)return;
      if(isPaymentMode){ amountToPay=parseFloat(val); document.getElementById('payAmount').innerText="â‚¹"+amountToPay; document.getElementById('bgOverlay').style.display="block"; setTimeout(()=>document.getElementById('bankSheet').classList.add('sheet-visible'),10); }
      else{ sendChatMessage(val); input.value=""; checkInput(); }
    }

    function closeBankSheet(){ document.getElementById('bankSheet').classList.remove('sheet-visible'); setTimeout(()=>document.getElementById('bgOverlay').style.display="none",300); }
    
    function openPinScreen(bank){ 
        closeBankSheet(); selectedBankName = bank; 
        document.getElementById('pinBankName').innerText = bank==='SBI'?"State Bank of India (8829)":"HDFC Bank"; 
        document.getElementById('pinAmt').innerText="â‚¹"+amountToPay; 
        document.getElementById('pinOverlay').style.display="flex"; pin=""; updateDots(); 
    }

    function kp(n){ if(pin.length<4){pin+=n; updateDots();} }
    function kd(){ pin=pin.slice(0,-1); updateDots(); }
    function updateDots(){ for(let i=1;i<=4;i++) document.getElementById('d'+i).className=i<=pin.length?"p-dot p-filled":"p-dot"; }
    
    function submitPin(){ 
        if(pin===correctPin){ 
            document.getElementById('pinOverlay').style.display="none"; 
            processPaymentFinal(amountToPay); input.value=""; checkInput(); 
        } else { alert("WRONG PIN! Try 1234"); pin=""; updateDots(); } 
    }

    function sendChatMessage(m){ document.getElementById('chatList').innerHTML+=`<div class="bubble sent">${m}</div>`; }

    // --- FINAL PAYMENT SIMULATION ---
    function processPaymentFinal(a){
      document.getElementById('chatList').innerHTML += `<div class="bubble paid"><div style="font-size:11px;color:#666;">Paying to ${name}</div><div class="amt-large">â‚¹ ${a}</div><div style="font-size:11px;color:#888;">Processing...</div></div>`;
      setTimeout(() => {
          location.href = `success.html?amount=${a}&name=${encodeURIComponent(name)}&bank=${selectedBankName}`; 
      }, 1500);
    }

    // ðŸš€ FIXED: Shows amount but WAITS for you to click PAY
    if(preFilledAmt){ 
        input.value=preFilledAmt; 
        checkInput(); 
        // Deleted the "setTimeout" line that was auto-clicking
    }
  </script>
</body>
</html>
